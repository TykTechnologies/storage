version: "3"

tasks:
  start-mongo:
    cmds:
      - echo "Starting MongoDB..."
      - docker run --name mongo -d -p 27017:27017 mongo:{{.MONGO_VERSION}}

  start-redis-single:
    cmds:
      - echo "Starting Redis single instance..."
      - docker run --name redis-single -d -p 6379:6379 redis:{{.REDIS_VERSION}}

  start-redis-cluster:
    cmds:
      - echo "Starting Redis Cluster..."
      - docker network create redis-cluster-net
      - >
        for port in $(seq 7000 7005); do
          docker run --name redis-${port} --net redis-cluster-net -d -p ${port}:${port} -p $((port+10000)):$((port+10000)) redis:{{.REDIS_VERSION}} redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes;
        done
      - docker run --net redis-cluster-net --rm redis:{{.REDIS_VERSION}} redis-cli --cluster create [ip:port list] --cluster-replicas 1 --cluster-yes
