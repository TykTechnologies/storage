version: "3"

tasks:
  start-mongo:
    cmds:
      - echo "Starting MongoDB..."
      - docker run --name mongo -d -p 27017:27017 mongo:{{.MONGO_VERSION}}

  start-redis-single:
    cmds:
      - echo "Starting Redis single instance..."
      - docker run --name redis-single -d -p 6379:6379 redis:{{.REDIS_VERSION}}

  start-redis-cluster:
    cmds:
      - echo "Starting Redis Cluster..."
      - docker network create redis-cluster-net
      - >
        for port in $(seq 7000 7005); do
          docker run --name redis-${port} --net redis-cluster-net -d -p ${port}:${port} -p $((port+10000)):$((port+10000)) redis:{{.REDIS_VERSION}} redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes;
          echo "Started Redis instance on port ${port}"
        done
      - echo "All Redis instances started. Proceeding to create the cluster."
      - >
        echo "Inspecting Docker containers for IP addresses:"
        for port in $(seq 7000 7005); do
          IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' redis-${port})
          echo "Redis instance redis-${port} IP: $IP"
        done
      - >
        echo "Creating Redis cluster with the following command:"
        echo "docker run --net redis-cluster-net --rm redis:{{.REDIS_VERSION}} redis-cli --cluster create $(for port in $(seq 7000 7005); do docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' redis-${port}):${port}; done) --cluster-replicas 1 --cluster-yes"
      - docker run --net redis-cluster-net --rm redis:{{.REDIS_VERSION}} redis-cli --cluster create $(for port in $(seq 7000 7005); do docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' redis-${port}):${port}; done) --cluster-replicas 1 --cluster-yes
