name: CI tests

on:
  pull_request:
    branches:
      - master
      - release-**

env:
  REDIS_HOST: localhost
  GO_VERSION: "1.19.x"

jobs:
  test:
    name: Go ${{ matrix.go-version }} Redis ${{ matrix.redis-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        redis-version: [6, 7]
        go-version: [1.19.x]

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Golang
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install Dependencies and basic hygiene test
        run: |
          # Adapt this block to fit your project's needs
          make lint

      - name: Start Redis
        uses: supercharge/redis-github-action@1.2.0
        with:
          redis-version: ${{ matrix.redis-version }}

      - name: Cache Go Modules
        uses: actions/cache@v2
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Install Go Dependencies
        run: go get github.com/go-redis/redis/v8

      - name: Run Tests
        run: |
          go test ./temporal/

      - name: Notify status
        if: ${{ failure() }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            # CI tests failed
            Please check the CI logs for more details.
